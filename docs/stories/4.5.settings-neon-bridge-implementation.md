# Story 4.5: Settings NEON Bridge Implementation

**Status:** Ready for Review

## Story

**As a** developer,
**I want** complete Blueprint ↔ Web communication for the Settings UI,
**so that** the NEON settings interface can load current values from UE5 and apply user changes back to the SettingsSubsystem.

## Acceptance Criteria

1. Settings UI receives initial settings data automatically when widget loads
2. User can apply settings changes from Web UI to UE5 subsystems
3. User can reset settings to engine defaults
4. Changes are only persisted when user clicks "Apply"
5. All communication uses proper NEON event architecture (UE5 pushes, Web requests)

## Tasks / Subtasks

- [x] Implement Web-side NEON event listeners (AC: 1, 2, 3, 4)
  - [x] Update SettingsContext.tsx to listen for UE5 initialization events
  - [x] Replace `NEON.invokeUnrealFunction` with event listener pattern
  - [x] Add event handler for reset to defaults
  - [x] Remove async function call pattern in favor of event-driven architecture
  - [x] Remove revertSettings function (not needed - user just doesn't apply)
  - [x] Test Web-side event reception and state updates
- [x] Document Blueprint requirements for UE5 implementation (AC: 1, 2, 3, 5)
  - [x] Specify exact event names and JSON structure for initialization
  - [x] Specify exact event names and JSON structure for apply/reset
  - [x] Document required Blueprint event bindings
  - [x] Create Blueprint implementation checklist
  - [x] Provide example JSON payloads for all events

## Dev Notes

### Architecture Decision

**Single NEON Widget Architecture:**
- **CRITICAL:** Use a single NEON widget (e.g., WBP_MainMenu) for the entire web application
- Web app handles its own routing (React Router, etc.) between pages
- Do NOT create separate NEON widgets per page (causes browser destruction/recreation, state loss, glitchiness)
- Web notifies UE5 when navigating to Settings page via `SettingsPageOpened` event

**Push-Based Architecture (UE5 → Web for initialization):**
- UE5 is the source of truth for all settings
- Web tells UE5 when Settings page opens via `SettingsPageOpened` event
- Blueprint responds by sending initial settings data
- Web listens for initialization events and populates UI
- This is simpler and matches proven `Invoke Web String/JSON Object` pattern

**Event-Driven Updates (Web → UE5 for changes):**
- Web sends events when user clicks Apply/Reset
- UE5 Blueprint receives events, updates subsystem
- UE5 sends updated values back to Web (for reset only)

**No Revert Needed:**
- User adjusts settings → updates local React state only
- User closes menu without clicking Apply → changes are discarded automatically
- This is standard UX pattern - simpler than explicit "Revert" button

### Blueprint Implementation Requirements

**IMPORTANT:** The user (not the dev agent) will implement the Blueprint side. This story documents what the Blueprint needs to do and what data formats to use.

**IMPORTANT:** All Blueprint implementation should be in the main NEON widget (e.g., WBP_MainMenu), NOT a separate Settings widget.

#### Event 0: SettingsPageOpened (Web → UE5)

**When to call:** When user navigates to Settings page in the web application

**Method:** NEON event listener in Blueprint (receives from Web)

**Event Name:** `SettingsPageOpened`

**JSON Structure Received:** None (no parameters)

**Purpose:** Web notifies UE5 that the Settings page has been opened, triggering UE5 to send initial settings data.

**Blueprint Implementation Steps:**
1. Create Custom Event: `SettingsPageOpened` (no parameters)
2. This event should execute the same logic as Event 1 (InitializeSettings) below
3. Bind this event to the NEON widget to receive calls from Web

**Web Implementation:** See "Web Implementation Requirements" section below for the `useEffect` hook that calls this.

---

#### Event 1: InitializeSettings (UE5 → Web)

**When to call:** In response to `SettingsPageOpened` event from Web

**Method:** `Invoke Web (Json Object)`

**Event Name:** `InitializeSettings`

**JSON Structure:**
```json
{
  "audio": {
    "MasterVolume": 1.0,
    "MusicVolume": 0.8,
    "SFXVolume": 1.0,
    "VoiceVolume": 1.0,
    "SelectedAudioDeviceId": "default"
  },
  "graphics": {
    "Resolution": {
      "X": 1920,
      "Y": 1080
    },
    "WindowMode": 0,
    "bVSyncEnabled": true,
    "FrameRateLimit": 0,
    "QualityPreset": 3
  },
  "input": {
    "MouseSensitivityX": 1.0,
    "MouseSensitivityY": 1.0,
    "ADSSensitivityMultiplier": 0.5,
    "bInvertMouseY": false,
    "GamepadSensitivityX": 1.0,
    "GamepadSensitivityY": 1.0,
    "bInvertGamepadY": false,
    "LeftStickDeadZone": 0.25,
    "RightStickDeadZone": 0.25,
    "bEnableVibration": true,
    "VibrationIntensity": 1.0
  }
}
```

**Blueprint Implementation Steps:**
1. Get Game Instance → Get Subsystem (NohamSettingsSubsystem)
2. Call "Get Audio Settings" → Returns FNohamAudioSettings struct
3. Call "Get Graphics Settings" → Returns FNohamGraphicsSettings struct
4. Call "Get Input Settings" → Returns FNohamInputSettings struct
5. Create JSON object combining all three structs
6. Use **Invoke Web (Json Object)** node
   - Method: `InitializeSettings`
   - Value: Combined JSON object

**Notes:**
- Use UE5's native JSON serialization to convert structs to JSON
- Struct field names will automatically match JSON keys (e.g., `MasterVolume`)
- This is a **one-way push** from UE5 to Web
- This loads the **currently saved settings** from disk
- This should be called from the `SettingsPageOpened` event handler

---

#### Event 2: ApplySettings (Web → UE5)

**When to call:** User clicks "Apply Settings" button in Web UI

**Method:** NEON event listener in Blueprint (receives from Web)

**Event Name:** `ApplySettings`

**JSON Structure Received:**
```json
{
  "audio": {
    "masterVolume": 0.75,
    "musicVolume": 0.6,
    "sfxVolume": 0.9,
    "voiceVolume": 1.0,
    "selectedAudioDeviceId": "default"
  },
  "graphics": {
    "resolution": { "x": 2560, "y": 1440 },
    "windowMode": 1,
    "vSyncEnabled": false,
    "frameRateLimit": 144,
    "qualityPreset": 2
  },
  "input": {
    "mouseSensitivityX": 1.5,
    "mouseSensitivityY": 1.5,
    "adsSensitivityMultiplier": 0.6,
    "invertMouseY": false,
    "gamepadSensitivityX": 1.2,
    "gamepadSensitivityY": 1.2,
    "invertGamepadY": false,
    "leftStickDeadZone": 0.3,
    "rightStickDeadZone": 0.3,
    "enableVibration": true,
    "vibrationIntensity": 0.8
  }
}
```

**Blueprint Implementation Steps:**
1. Create Custom Event: `ApplySettings` with String parameter (JSON)
2. Parse JSON string to extract "audio", "graphics", "input" fields
3. Convert each JSON section to appropriate UE5 struct:
   - Audio JSON → FNohamAudioSettings
   - Graphics JSON → FNohamGraphicsSettings
   - Input JSON → FNohamInputSettings
4. Get Game Instance → Get Subsystem (NohamSettingsSubsystem)
5. Call subsystem methods:
   - `Update Audio Settings(audioStruct)`
   - `Update Graphics Settings(graphicsStruct)`
   - `Update Input Settings(inputStruct)`
6. Call `Save Settings()` to persist to disk
7. (Optional) Send success confirmation back to Web

**Blueprint Binding:**
- Bind this event to the NEON widget to receive calls from Web

**Notes:**
- Web sends camelCase JSON, need to map to PascalCase UE5 fields
- Validation happens in subsystem methods (range checks, etc.)
- This is a **one-way event** from Web to UE5
- This is the **only** way settings are saved - user must explicitly click Apply

---

#### Event 3: ResetToDefaults (Web → UE5 → Web)

**When to call:** User clicks "Reset to Defaults" button in Web UI

**Method:** NEON event listener in Blueprint (receives from Web)

**Event Name:** `ResetToDefaults`

**JSON Structure Received:** None (no parameters)

**Blueprint Implementation Steps:**
1. Create Custom Event: `ResetToDefaults` (no parameters)
2. Get Game Instance → Get Subsystem (NohamSettingsSubsystem)
3. Call `Reset To Defaults()`
4. Get updated settings from subsystem:
   - `Get Audio Settings`
   - `Get Graphics Settings`
   - `Get Input Settings`
5. Create JSON object with default values
6. Use **Invoke Web (Json Object)** node
   - Method: `SettingsReset`
   - Value: Default settings JSON (same structure as InitializeSettings)

**Blueprint Binding:**
- Bind this event to the NEON widget to receive calls from Web

**Notes:**
- After reset, UE5 **pushes default values back** to Web
- Web UI will update to show default values in real-time
- User still needs to click "Apply" to save these defaults
- This is **bidirectional**: Web requests, UE5 responds with data

---

### Web Implementation Requirements

The dev agent will update the Web side to:

1. **Remove async function calls** - No more `NEON.invokeUnrealFunction()`
2. **Remove revertSettings** - Not needed, user just doesn't click Apply
3. **Add window event listeners** - Listen for UE5 to push data
4. **Send events for user actions** - Use `NEON.invokeUnrealEvent()`
5. **Update state reactively** - When UE5 sends data, update React state

**Example Web Code Pattern:**

```typescript
// In SettingsContext.tsx or Settings page component
useEffect(() => {
  // STEP 1: Tell UE5 that Settings page has been opened
  if (typeof NEON !== 'undefined' && NEON.invokeUnrealEvent) {
    NEON.invokeUnrealEvent('SettingsPageOpened', {});
    console.log('[Settings] Notified UE5 that Settings page opened');
  }

  // STEP 2: Set up event listeners for UE5 responses
  window.InitializeSettings = (settingsJSON: object) => {
    console.log('[Settings] Received InitializeSettings from UE5:', settingsJSON);
    setAudioSettings(settingsJSON.audio);
    setGraphicsSettings(settingsJSON.graphics);
    setInputSettings(settingsJSON.input);
  };

  window.SettingsReset = (settingsJSON: object) => {
    console.log('[Settings] Received SettingsReset from UE5:', settingsJSON);
    setAudioSettings(settingsJSON.audio);
    setGraphicsSettings(settingsJSON.graphics);
    setInputSettings(settingsJSON.input);
  };

  // STEP 3: Cleanup on unmount
  return () => {
    delete window.InitializeSettings;
    delete window.SettingsReset;
  };
}, []); // Empty dependency array - runs once when Settings page mounts

// Apply: Send settings to UE5 and save
const applyAllSettings = () => {
  NEON.invokeUnrealEvent('ApplySettings', {
    audio: audioSettings,
    graphics: graphicsSettings,
    input: inputSettings
  });
  console.log('[Settings] Sent ApplySettings to UE5');
};

// Reset: Request UE5 to reset to defaults
const resetToDefaults = () => {
  NEON.invokeUnrealEvent('ResetToDefaults', {});
  console.log('[Settings] Requested ResetToDefaults from UE5');
  // UE5 will call window.SettingsReset with default values
};
```

---

### NEON Invoke Methods Available

Based on user confirmation, these are the available Blueprint invoke methods:

1. **Invoke Web String** - Send string to Web
2. **Invoke Web (Json Object)** - Send JSON object to Web ⭐ **USE THIS**
3. **Invoke Web Float** - Send float to Web
4. **Invoke Web Integer** - Send integer to Web
5. **Invoke Web (no param)** - Trigger Web event with no data

**Recommendation:** Use **Invoke Web (Json Object)** for all settings data transfer. It's type-safe and matches our JSON structure perfectly.

---

### Data Flow Summary

```
┌─────────────────────────────────────────────────────────────┐
│ INITIALIZATION FLOW (Web → UE5 → Web)                      │
├─────────────────────────────────────────────────────────────┤
│ 1. User navigates to Settings page in web app              │
│ 2. Settings component mounts (useEffect runs)              │
│ 3. Web: NEON.invokeUnrealEvent('SettingsPageOpened')      │
│ 4. Blueprint: SettingsPageOpened event receives call      │
│ 5. Blueprint: Get all settings from subsystem             │
│ 6. Blueprint: Invoke Web (Json Object) → "InitializeSettings" │
│ 7. Web: window.InitializeSettings receives JSON          │
│ 8. Web: Updates React state with saved settings          │
│ 9. Web: UI renders with current saved values             │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│ USER ADJUSTS SETTINGS (Web only - no UE5 call)             │
├─────────────────────────────────────────────────────────────┤
│ 1. User moves sliders, changes dropdowns, etc.             │
│ 2. Web: Updates local React state only                     │
│ 3. No Blueprint calls - changes are temporary              │
│ 4. UI shows new values but nothing is saved               │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│ APPLY FLOW (Web → UE5)                                      │
├─────────────────────────────────────────────────────────────┤
│ 1. User clicks "Apply" button                              │
│ 2. Web: NEON.invokeUnrealEvent('ApplySettings', {...})    │
│ 3. Blueprint: ApplySettings event receives JSON           │
│ 4. Blueprint: Parse JSON → UE5 structs                    │
│ 5. Blueprint: Call subsystem Update methods               │
│ 6. Blueprint: Call Save Settings (persists to disk)       │
│ 7. UE5: Settings applied and saved                        │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│ CANCEL FLOW (Web only - no UE5 call needed)                │
├─────────────────────────────────────────────────────────────┤
│ 1. User adjusts settings but doesn't click Apply          │
│ 2. User closes Settings menu                              │
│ 3. Web: Component unmounts, React state is discarded      │
│ 4. Next time menu opens: loads saved settings from UE5    │
│ 5. Result: Changes were never saved, user got "revert"    │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│ RESET FLOW (Web → UE5 → Web)                               │
├─────────────────────────────────────────────────────────────┤
│ 1. User clicks "Reset to Defaults" button                 │
│ 2. Web: NEON.invokeUnrealEvent('ResetToDefaults', {})     │
│ 3. Blueprint: ResetToDefaults event fires                  │
│ 4. Blueprint: Call subsystem Reset To Defaults            │
│ 5. Blueprint: Get default settings from subsystem         │
│ 6. Blueprint: Invoke Web (Json Object) → "SettingsReset"  │
│ 7. Web: window.SettingsReset receives JSON               │
│ 8. Web: Updates React state with default values          │
│ 9. Web: UI updates to show defaults                      │
│ 10. User must still click "Apply" to save defaults       │
└─────────────────────────────────────────────────────────────┘
```

---

### Blueprint Implementation Checklist

**For the user to implement in UE5 Blueprint:**

**CRITICAL:** Implement all of this in your main NEON widget (e.g., WBP_MainMenu), NOT a separate widget.

Main NEON Widget Blueprint (e.g., WBP_MainMenu):

- [ ] **Custom Event: SettingsPageOpened**
  - [ ] Create custom event (no parameters)
  - [ ] Get NohamSettingsSubsystem reference (Get Game Instance → Get Subsystem)
  - [ ] Call Get Audio Settings
  - [ ] Call Get Graphics Settings
  - [ ] Call Get Input Settings
  - [ ] Combine into single JSON object
  - [ ] Invoke Web (Json Object) with method name "InitializeSettings"
  - [ ] Bind this event to NEON widget to receive calls from Web

- [ ] **Custom Event: ApplySettings**
  - [ ] Create custom event with String input parameter
  - [ ] Parse JSON string to extract audio/graphics/input
  - [ ] Convert JSON sections to UE5 structs
  - [ ] Get NohamSettingsSubsystem reference
  - [ ] Call Update Audio Settings
  - [ ] Call Update Graphics Settings
  - [ ] Call Update Input Settings
  - [ ] Call Save Settings (persist to disk)
  - [ ] Bind this event to NEON widget

- [ ] **Custom Event: ResetToDefaults**
  - [ ] Create custom event (no parameters)
  - [ ] Get NohamSettingsSubsystem reference
  - [ ] Call Reset To Defaults
  - [ ] Get default settings (all three categories)
  - [ ] Combine into JSON object
  - [ ] Invoke Web (Json Object) with method name "SettingsReset"
  - [ ] Bind this event to NEON widget

---

### Example JSON Payloads

**InitializeSettings / SettingsReset Payload:**
```json
{
  "audio": {
    "MasterVolume": 1.0,
    "MusicVolume": 0.8,
    "SFXVolume": 1.0,
    "VoiceVolume": 1.0,
    "SelectedAudioDeviceId": "default"
  },
  "graphics": {
    "Resolution": {
      "X": 1920,
      "Y": 1080
    },
    "WindowMode": 0,
    "bVSyncEnabled": true,
    "FrameRateLimit": 0,
    "QualityPreset": 3
  },
  "input": {
    "MouseSensitivityX": 1.0,
    "MouseSensitivityY": 1.0,
    "ADSSensitivityMultiplier": 0.5,
    "bInvertMouseY": false,
    "GamepadSensitivityX": 1.0,
    "GamepadSensitivityY": 1.0,
    "bInvertGamepadY": false,
    "LeftStickDeadZone": 0.25,
    "RightStickDeadZone": 0.25,
    "bEnableVibration": true,
    "VibrationIntensity": 1.0
  }
}
```

**ApplySettings Payload (sent from Web to UE5):**
```json
{
  "audio": {
    "masterVolume": 0.75,
    "musicVolume": 0.6,
    "sfxVolume": 0.9,
    "voiceVolume": 1.0,
    "selectedAudioDeviceId": "default"
  },
  "graphics": {
    "resolution": { "x": 2560, "y": 1440 },
    "windowMode": 1,
    "vSyncEnabled": false,
    "frameRateLimit": 144,
    "qualityPreset": 2
  },
  "input": {
    "mouseSensitivityX": 1.5,
    "mouseSensitivityY": 1.5,
    "adsSensitivityMultiplier": 0.6,
    "invertMouseY": false,
    "gamepadSensitivityX": 1.2,
    "gamepadSensitivityY": 1.2,
    "invertGamepadY": false,
    "leftStickDeadZone": 0.3,
    "rightStickDeadZone": 0.3,
    "enableVibration": true,
    "vibrationIntensity": 0.8
  }
}
```

**Note:** UE5 uses PascalCase (MasterVolume), Web uses camelCase (masterVolume). Blueprint must handle this conversion when parsing ApplySettings JSON.

---

### Coding Standards

**Web Standards:**
- NEON Communication uses event-driven architecture [Source: architecture/coding-standards.md]
- Validate all incoming data from UE5 before updating state [Source: architecture/coding-standards.md]
- Use TypeScript interfaces for all NEON data structures [Source: architecture/coding-standards.md]

**Blueprint Standards:**
- Use proper error handling for JSON parsing
- Log all NEON communication events for debugging
- Validate settings before applying to subsystems
- Use subsystem validation methods (ValidateAudioSettings, etc.)

---

### Testing

**Web-Side Testing:**
- Verify event listeners attach correctly on component mount
- Verify event listeners clean up on unmount
- Test receiving initialization data from UE5
- Test sending apply/reset events
- Verify state updates when receiving reset data
- Verify closing menu without Apply discards changes

**Blueprint Testing (Manual):**
- Open Settings menu in PIE (Play In Editor)
- Verify browser loads and receives initial settings
- Adjust settings (don't click Apply) and close menu
- Reopen menu - verify settings reverted to saved values
- Adjust settings and click Apply - verify subsystem receives data
- Click Reset - verify defaults appear in UI
- Click Apply after Reset - verify defaults are saved

**Integration Testing:**
- Full round-trip: Load → Modify → Apply → Close → Reopen (verify persistence)
- Test cancel flow: Load → Modify → Close (without Apply) → Reopen (verify unchanged)
- Test reset flow: Load → Reset → Apply → Close → Reopen (verify defaults saved)
- Test with invalid data (out of range values)
- Verify validation errors are handled gracefully

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-09 | 1.0 | Initial story creation with Blueprint requirements (Apply/Reset only, no Revert) | James (Dev Agent) |
| 2025-01-09 | 2.0 | Implemented Web-side event-driven architecture | James (Dev Agent) |
| 2025-01-09 | 2.1 | Updated architecture to use single NEON widget with SettingsPageOpened event | James (Dev Agent) |

## Dev Agent Record

### Agent Model Used
claude-sonnet-4-5-20250929

### Debug Log References
None - Web-side implementation only, no C++ changes

### Completion Notes List

**Web-Side Implementation Complete:**
- ✅ Replaced async `NEON.invokeUnrealFunction` with event-driven architecture
- ✅ Added `window.InitializeSettings` event listener for UE5 → Web initialization
- ✅ Added `window.SettingsReset` event listener for default values from UE5
- ✅ Removed `revertSettings` function and related UI (user closes menu to discard changes)
- ✅ Updated TypeScript interfaces with complete GraphicsSettings and InputSettings
- ✅ Implemented PascalCase (UE5) to camelCase (Web) conversion in event handlers
- ✅ Made `applyAllSettings` and `resetToDefaults` synchronous (no async/await)
- ✅ Updated SettingsManagement.tsx UI with clearer messaging about Apply/Reset flow
- ✅ Added `SettingsPageOpened` event call in useEffect to notify UE5 when Settings page mounts
- ✅ Build successful with no TypeScript errors

**Architecture Implementation:**
- **Single NEON Widget:** All implementation uses WBP_MainMenu (no separate Settings widget)
- Web sends `SettingsPageOpened` event when Settings component mounts
- UE5 responds with `InitializeSettings` containing current saved settings
- Web sends `ApplySettings` event to UE5 when user clicks Apply button
- Web sends `ResetToDefaults` event to UE5, receives `SettingsReset` response
- All settings changes update local React state only until Apply is clicked
- Closing menu without Apply automatically discards changes (no Revert needed)

**Blueprint Requirements Documented:**
- Complete JSON structure specifications for all events
- PascalCase/camelCase conversion requirements clearly documented
- Step-by-step Blueprint implementation checklist provided
- Example JSON payloads for InitializeSettings, ApplySettings, and SettingsReset

### File List
**Web Files Modified:**
- `Content/UI/NEON/Settings/SettingsContext.tsx` - Refactored to event-driven architecture
- `Content/UI/NEON/Settings/SettingsManagement.tsx` - Removed Revert button, updated UI messaging
- `Content/UI/NEON/dist/Settings/index.html` - Built successfully (101.52 kB JS bundle)

**Blueprint Files (User Implementation Required):**
- Settings NEON Widget Blueprint - Needs OnBrowserCreated, ApplySettings, ResetToDefaults events

**No C++ changes required** - All existing subsystem methods already support this architecture

---

## QA Results

_To be filled by QA agent_
